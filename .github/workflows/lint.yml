name: Kotlin Lint

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  checks: write
  security-events: write

jobs:
  detekt:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Detekt
        continue-on-error: true
        run: ./gradlew detekt

      - name: Upload Detekt SARIF report
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: build/reports/detekt/merge.sarif

      - name: Comment on PR with lint results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const detektPath = 'build/reports/detekt/merge.sarif';

            if (!fs.existsSync(detektPath)) {
              console.log('No detekt report found');
              return;
            }

            const detektReport = JSON.parse(fs.readFileSync(detektPath, 'utf8'));
            let issueCount = 0;

            if (detektReport.runs && Array.isArray(detektReport.runs)) {
              detektReport.runs.forEach(run => {
                if (run.results && Array.isArray(run.results)) {
                  issueCount += run.results.length;
                }
              });
            }

            if (issueCount > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸ“‹ Detekt found ${issueCount} code quality issue(s). Check the [code scanning tab](../../security/code-scanning) for details.`
              });
            }

      - name: Publish lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            build/reports/detekt/
          retention-days: 30

      - name: Fail if detekt found issues
        run: ./gradlew detekt
        continue-on-error: false
        if: ${{ always() && github.event_name == 'pull_request' }}